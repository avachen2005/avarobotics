# Implementation Plan: AWS IAM Permissions

**Branch**: `002-aws-iam-permissions` | **Date**: 2026-02-01 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-aws-iam-permissions/spec.md`

## Summary

建立 AWS IAM 權限管理架構，遵循 User → Role → Policy 最佳實踐。提供 `TerraformDeployRole` 讓現有 IAM User (`avarobotics_local`) 可以 assume，並附加兩個分離的 Policy：State Backend Policy（S3 + DynamoDB）和 Infrastructure Policy（VPC, ALB, S3, CloudWatch 等）。目標是讓 001-aws-api-infra 可以順利執行 terraform apply。

## Technical Context

**Language/Version**: Terraform >= 1.5.0 (HCL)
**Primary Dependencies**: AWS Provider ~> 5.0
**Storage**: N/A (IAM 是 AWS 全域服務)
**Testing**: terraform validate, terraform plan, AWS IAM Policy Simulator
**Target Platform**: AWS (Global service, primary region: ap-northeast-1)
**Project Type**: Infrastructure as Code (Terraform module)
**Performance Goals**: N/A (IAM 操作無性能要求)
**Constraints**: 最小權限原則、不使用 `*` 萬用字元、4 小時 session duration、不需要 MFA
**Scale/Scope**: 單一 AWS 帳戶、單一 IAM User、單一 Role、2 個 Policy

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Constitution 尚未為此專案客製化（僅有範本）。使用一般最佳實踐：

| Principle | Status | Notes |
|-----------|--------|-------|
| Infrastructure as Code | ✅ Pass | 所有 IAM 資源使用 Terraform 定義 |
| Security Best Practices | ✅ Pass | User → Role → Policy 架構、最小權限原則 |
| Version Control | ✅ Pass | Git-tracked, PR-based workflow |
| Testability | ✅ Pass | terraform validate + IAM Policy Simulator |
| Simplicity | ✅ Pass | 最少資源數量達成目標 |

## Project Structure

### Documentation (this feature)

```text
specs/002-aws-iam-permissions/
├── plan.md              # This file
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output (IAM resource relationships)
├── quickstart.md        # Phase 1 output
├── contracts/           # Phase 1 output (Policy documents)
│   ├── iam-role.md      # Role and Trust Policy interface
│   ├── state-backend-policy.md   # S3 + DynamoDB permissions
│   └── infrastructure-policy.md  # VPC, ALB, etc. permissions
└── tasks.md             # Phase 2 output (/speckit.tasks command)
```

### Source Code (repository root)

```text
terraform/
├── modules/
│   └── iam/
│       ├── main.tf           # Role, Trust Policy, Policy attachments
│       ├── variables.tf      # Input variables
│       ├── outputs.tf        # Role ARN, Policy ARNs
│       └── policies/
│           ├── state-backend.json    # S3 + DynamoDB policy document
│           └── infrastructure.json   # VPC, ALB, etc. policy document
│
└── environments/
    └── dev/
        └── main.tf           # 引用 iam module (已存在，需更新)
```

**Structure Decision**: 建立獨立的 `iam` module 在 `terraform/modules/` 下，與現有的 networking, security, loadbalancing 等 module 並列。Policy 文件使用 JSON 格式存放在 module 內的 policies/ 目錄。

## Complexity Tracking

No violations requiring justification. Design follows minimal complexity principle:
- 1 Role (TerraformDeployRole)
- 2 Policies (State Backend + Infrastructure)
- 1 Trust Policy (allow avarobotics_local to assume)

## Implementation Phases

### Phase 0: Research (Completed in research.md)
- AWS IAM assume role best practices
- Minimum permissions for Terraform state backend
- Minimum permissions for infrastructure deployment

### Phase 1: Design (Completed in data-model.md, contracts/)
- IAM resource dependency graph
- Policy document structure
- Role trust relationship

### Phase 2: Tasks (Generated by /speckit.tasks)
- PR-sized implementation tasks
- Dependency ordering
- Verification steps for each PR
